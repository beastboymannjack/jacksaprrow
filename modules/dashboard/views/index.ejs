<%- include('header'); -%>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="/sweetalert.css">
    <title>Bot Hosting | Dashboard</title>
</head>

<div style="max-width: 1200px; margin: 0 auto;">
    <% if (typeof loginError !== 'undefined' && loginError) { %>
    <div class="alert" style="margin-bottom: 20px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); color: #ef4444;">
        <i class="fa fa-times-circle"></i>
        <span><%= loginError %></span>
    </div>
    <% } else if (typeof botReady !== 'undefined' && !botReady) { %>
    <div class="alert alert-warning" style="margin-bottom: 20px;">
        <i class="fa fa-exclamation-triangle"></i>
        <span>The Discord bot is still connecting. Some features may be limited. Please wait a moment and refresh the page.</span>
    </div>
    <% } %>
    
    <div style="margin-bottom: 32px;">
        <h1 class="section-title">Dashboard</h1>
        <p style="color: var(--text-secondary); font-size: 0.95rem;">Welcome back! Here's an overview of your hosting environment.</p>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 32px;">
        <div class="card stat-card">
            <div class="stat-value" style="color: var(--primary-light);" id="totalBots">
                <%= typeof botStats !== 'undefined' ? botStats.total : '0' %>
            </div>
            <div class="stat-label">Total Bots</div>
        </div>
        <div class="card stat-card">
            <div class="stat-value" style="color: var(--accent);" id="runningBots">
                <%= typeof botStats !== 'undefined' ? botStats.running : '0' %>
            </div>
            <div class="stat-label">Running</div>
        </div>
        <div class="card stat-card">
            <div class="stat-value" style="color: var(--danger);" id="stoppedBots">
                <%= typeof botStats !== 'undefined' ? botStats.stopped : '0' %>
            </div>
            <div class="stat-label">Stopped</div>
        </div>
        <div class="card stat-card">
            <div class="stat-value" style="color: var(--warning);" id="ping">
                <%= botClient.ws.ping %>
            </div>
            <div class="stat-label">Ping (ms)</div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 32px;">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><i class="fa fa-bolt" style="margin-right: 8px; color: var(--primary);"></i>Quick Actions</h3>
            </div>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <a href="/createbot" class="btn btn-primary" style="justify-content: center;">
                    <i class="fa fa-plus"></i> Create New Bot
                </a>
                <a href="/managebots" class="btn btn-success" style="justify-content: center;">
                    <i class="fa fa-robot"></i> Manage Bots
                </a>
                <a href="/logs" class="btn btn-outline" style="justify-content: center;">
                    <i class="fa fa-file-alt"></i> View Activity Logs
                </a>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><i class="fa fa-info-circle" style="margin-right: 8px; color: var(--info);"></i>System Information</h3>
            </div>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                    <span style="color: var(--text-muted); font-size: 0.875rem;">Node.js Version</span>
                    <span style="color: var(--text-primary); font-weight: 500; font-size: 0.875rem;"><%= process.version %></span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                    <span style="color: var(--text-muted); font-size: 0.875rem;">Platform</span>
                    <span style="color: var(--text-primary); font-weight: 500; font-size: 0.875rem;"><%= process.platform %></span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                    <span style="color: var(--text-muted); font-size: 0.875rem;">Memory Usage</span>
                    <span style="color: var(--text-primary); font-weight: 500; font-size: 0.875rem;"><%= Math.round(process.memoryUsage().heapUsed / 1024 / 1024) %> MB</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                    <span style="color: var(--text-muted); font-size: 0.875rem;">Uptime</span>
                    <span style="color: var(--text-primary); font-weight: 500; font-size: 0.875rem;"><%= Math.floor(process.uptime() / 3600) %>h <%= Math.floor((process.uptime() % 3600) / 60) %>m</span>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title"><i class="fa fa-activity" style="margin-right: 8px; color: var(--accent);"></i>Service Status</h3>
            <span id="statusBadge" class="badge <%= botClient?.createingbotmap?.has('Creating') ? 'badge-warning' : 'badge-success' %>">
                <%= botClient?.createingbotmap?.has("Creating") ? 'Creating Bot' : 'All Systems Operational' %>
            </span>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-input); border-radius: 8px;">
                <div style="width: 8px; height: 8px; background: var(--accent); border-radius: 50%;"></div>
                <div>
                    <div style="font-size: 0.875rem; font-weight: 500;">Dashboard</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">Online</div>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-input); border-radius: 8px;">
                <div style="width: 8px; height: 8px; background: var(--accent); border-radius: 50%;"></div>
                <div>
                    <div style="font-size: 0.875rem; font-weight: 500;">Discord Gateway</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">Connected</div>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-input); border-radius: 8px;">
                <div style="width: 8px; height: 8px; background: var(--accent); border-radius: 50%;"></div>
                <div>
                    <div style="font-size: 0.875rem; font-weight: 500;">Bot Process Manager</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">Running</div>
                </div>
            </div>
        </div>
    </div>
</div>

</main>

<script>
    window.onload = function() {
        setInterval(() => {
            var xmlhttp = new XMLHttpRequest();
            xmlhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    try {
                        var data = this.responseText;
                        var parser = new DOMParser();
                        var doc = parser.parseFromString(data, "text/html");
                        var ping = doc.querySelector("#ping");
                        var statusBadge = doc.querySelector("#statusBadge");
                        if (ping) document.getElementById("ping").innerHTML = ping.innerHTML;
                        if (statusBadge) document.getElementById("statusBadge").innerHTML = statusBadge.innerHTML;
                    } catch (e) { console.log(e); }
                }
            };
            xmlhttp.open("GET", "/", true);
            xmlhttp.send();
        }, 5000);
    };
</script>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('success') && urlParams.get('success')) {
        Swal.fire({
            icon: 'success',
            title: 'Success!',
            showCloseButton: true,
            text: urlParams.get('message'),
            background: '#13132b',
            color: '#f1f5f9'
        }).then(() => window.location.href = '/');
    }
    if (urlParams.has('error') && urlParams.get('error')) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: urlParams.get('message'),
            showCloseButton: true,
            background: '#13132b',
            color: '#f1f5f9'
        }).then(() => window.location.href = '/');
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
